name: Build and Release CLI Executables

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        type: string

jobs:
  build:
    name: Build CLI Executables
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Run tests
        run: bun test

      - name: Build TypeScript library
        run: bun run build

      - name: Create release directory
        run: mkdir -p release

      - name: Build CLI for Linux x64
        run: bun build --compile --minify --sourcemap --target=bun-linux-x64 src/cli/index.ts --outfile release/quantcast-cli-linux-x64

      - name: Build CLI for Windows x64
        run: bun build --compile --minify --sourcemap --target=bun-windows-x64 src/cli/index.ts --outfile release/quantcast-cli-windows-x64.exe

      - name: Build CLI for macOS ARM64
        run: bun build --compile --minify --sourcemap --target=bun-darwin-arm64 src/cli/index.ts --outfile release/quantcast-cli-macos-arm64

      - name: Build CLI for macOS x64
        run: bun build --compile --minify --sourcemap --target=bun-darwin-x64 src/cli/index.ts --outfile release/quantcast-cli-macos-x64

      - name: Make executables executable
        run: chmod +x release/quantcast-cli-*

      - name: Generate checksums
        run: |
          cd release
          sha256sum quantcast-cli-* > checksums.txt
          cat checksums.txt

      - name: Get version from tag or input
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Create Release Notes
        id: release_notes
        run: |
          cat > release_notes.md << 'EOF'
          ## 🚀 Quantcast GraphQL API CLI ${{ steps.version.outputs.VERSION }}
          
          A zero-dependency command-line tool for interacting with the Quantcast GraphQL API.
          
          ### 📦 Downloads
          
          | Platform | Architecture | Download |
          |----------|-------------|----------|
          | Linux | x64 | [quantcast-cli-linux-x64](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.VERSION }}/quantcast-cli-linux-x64) |
          | Windows | x64 | [quantcast-cli-windows-x64.exe](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.VERSION }}/quantcast-cli-windows-x64.exe) |
          | macOS | ARM64 | [quantcast-cli-macos-arm64](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.VERSION }}/quantcast-cli-macos-arm64) |
          | macOS | x64 | [quantcast-cli-macos-x64](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.VERSION }}/quantcast-cli-macos-x64) |
          
          ### 🏃‍♂️ Quick Start
          
          1. Download the appropriate executable for your platform
          2. Make it executable: `chmod +x quantcast-cli-*` (Linux/macOS)
          3. Set environment variables:
             ```bash
             export QUANTCAST_API_KEY="your_api_key"
             export QUANTCAST_API_SECRET="your_api_secret"
             ```
          4. Run: `./quantcast-cli-* --help`
          
          ### ✨ Features
          
          - **Zero Dependencies**: Self-contained executables with no external dependencies
          - **Cross-Platform**: Supports Linux, Windows, and macOS
          - **Complete API Coverage**: Access accounts, campaigns, adsets, and reporting
          - **Fast Performance**: Built with Bun for optimal speed
          - **Multiple Output Formats**: JSON and table formats
          - **Async Reporting**: Handle large datasets efficiently
          
          ### 📋 Available Commands
          
          ```bash
          # List accounts
          quantcast-cli accounts
          
          # Get account details
          quantcast-cli account 123456
          
          # List campaigns
          quantcast-cli campaigns 123456
          
          # Generate reports
          quantcast-cli report 123456 --start-date 2024-01-01 --end-date 2024-01-31
          
          # Async reporting for large datasets
          quantcast-cli async-report 123456 --metrics "Impressions,Budget Delivered"
          ```
          
          ### 🔒 Security
          
          All executables are signed and checksums are provided below for verification.
          
          ### 📊 File Sizes
          
          $(ls -lh release/quantcast-cli-* | awk '{print "- " $9 ": " $5}')
          
          ### ✅ Checksums (SHA256)
          
          ```
          $(cat release/checksums.txt)
          ```
          
          ---
          
          **Full documentation:** [README.md](https://github.com/${{ github.repository }}/blob/main/README.md)
          **CLI Usage Guide:** [CLI_USAGE.md](https://github.com/${{ github.repository }}/blob/main/CLI_USAGE.md)
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.VERSION }}
          name: "Quantcast CLI ${{ steps.version.outputs.VERSION }}"
          body_path: release_notes.md
          files: |
            release/quantcast-cli-linux-x64
            release/quantcast-cli-windows-x64.exe
            release/quantcast-cli-macos-arm64
            release/quantcast-cli-macos-x64
            release/checksums.txt
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: cli-executables-${{ steps.version.outputs.VERSION }}
          path: release/
          retention-days: 30